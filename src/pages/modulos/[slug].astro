---
/**
 * [slug].astro
 * Template dinâmico para páginas de módulos
 * Renderiza conteúdo Markdown com estilo vintage
 */
import { getCollection, getEntry } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';

export async function getStaticPaths() {
  const modules = await getCollection('modulos');
  return modules.map((mod) => ({
    params: { slug: mod.slug },
    props: { mod },
  }));
}

const { mod } = Astro.props;
const { Content, headings } = await mod.render();

// Navegação entre módulos
const allModules = await getCollection('modulos');
const sortedModules = allModules.sort((a, b) => a.data.order - b.data.order);
const currentIndex = sortedModules.findIndex(m => m.slug === mod.slug);
const prevModule = currentIndex > 0 ? sortedModules[currentIndex - 1] : null;
const nextModule = currentIndex < sortedModules.length - 1 ? sortedModules[currentIndex + 1] : null;
---

<BaseLayout title={mod.data.title} description={mod.data.description}>
  <article class="module-page">
    <!-- Header do módulo -->
    <header class="module-header">
      <div class="module-header__container">
        <span class="module-header__number">Módulo {mod.data.moduleNumber}</span>
        <h1 class="module-header__title">{mod.data.title}</h1>
        <p class="module-header__subtitle">{mod.data.subtitle}</p>

        <div class="module-header__drugs">
          {mod.data.drugs.map((drug: string) => (
            <span class="module-header__drug-tag">{drug}</span>
          ))}
        </div>

        {mod.data.slidesUrl && (
          <a
            href={mod.data.slidesUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="module-header__slides-btn"
          >
            Abrir Apresentação de Slides
          </a>
        )}
      </div>

      <!-- Placeholder para bactéria -->
      <div class="module-header__bacteria">
        <div class:list={["module-header__bacteria-icon", { "module-header__bacteria-icon--image": mod.data.bacteriaImage }]}>
          {mod.data.bacteriaImage ? (
            <img
              src={mod.data.bacteriaImage}
              alt={mod.data.bacteriaAlt ?? mod.data.bacteriaPlaceholder ?? "Bactéria"}
              class="module-header__bacteria-img"
              loading="lazy"
            />
          ) : (
            <span class="module-header__bacteria-placeholder">{mod.data.bacteriaPlaceholder || mod.data.bacteriaAlt || "Bactéria"}</span>
          )}
        </div>
      </div>
    </header>

    <!-- Conteúdo do módulo -->
    <div class="module-content">
      <div class="module-content__body content-section">
        <Content />
      </div>

      <!-- Sidebar com navegação -->
      <aside class="module-sidebar">
        <div class="module-sidebar__sticky">
          <!-- Navegação principal (sempre visível no topo) -->
          <div class="module-sidebar__nav-section">
            <h3 class="module-sidebar__title">Navegação</h3>
            <nav class="module-sidebar__nav">
              <a href="/modulos" class="module-sidebar__link">
                ← Todos os Módulos
              </a>
              <a href="/guia-rapido" class="module-sidebar__link">
                Guia de Consulta Rápida
              </a>
            </nav>
          </div>

          {(prevModule || nextModule) && (
            <div class="module-sidebar__pagination">
              <h4>Módulos</h4>
              {prevModule && (
                <a href={`/modulos/${prevModule.slug}`} class="module-sidebar__prev">
                  <span class="module-sidebar__pagination-label">Anterior</span>
                  <span class="module-sidebar__pagination-title">{prevModule.data.title}</span>
                </a>
              )}
              {nextModule && (
                <a href={`/modulos/${nextModule.slug}`} class="module-sidebar__next">
                  <span class="module-sidebar__pagination-label">Próximo</span>
                  <span class="module-sidebar__pagination-title">{nextModule.data.title}</span>
                </a>
              )}
            </div>
          )}

          <!-- Table of Contents (Desktop) - com scroll independente -->
          <div class="module-sidebar__toc-wrapper">
            <TableOfContents headings={headings} maxDepth={3} variant="desktop" />
          </div>
        </div>
      </aside>
    </div>

    <!-- Navegação inferior -->
    <nav class="module-pagination">
      {prevModule ? (
        <a href={`/modulos/${prevModule.slug}`} class="module-pagination__link module-pagination__link--prev">
          <span class="module-pagination__label">← Módulo Anterior</span>
          <span class="module-pagination__title">{prevModule.data.title}</span>
        </a>
      ) : (
        <div></div>
      )}
      {nextModule && (
        <a href={`/modulos/${nextModule.slug}`} class="module-pagination__link module-pagination__link--next">
          <span class="module-pagination__label">Próximo Módulo →</span>
          <span class="module-pagination__title">{nextModule.data.title}</span>
        </a>
      )}
    </nav>
  </article>

  <!-- Table of Contents Mobile (FAB) - fora do article para evitar contexto de stacking -->
  <TableOfContents headings={headings} maxDepth={3} variant="mobile" />
</BaseLayout>

<style>
  .module-page {
    background: var(--color-cream);
  }

  /* Header do módulo */
  .module-header {
    background: linear-gradient(
      180deg,
      var(--color-burgundy) 0%,
      var(--color-sepia-dark) 100%
    );
    color: var(--text-light);
    padding: var(--space-2xl) var(--space-lg);
    position: relative;
    overflow: hidden;
  }

  .module-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(
      ellipse at bottom right,
      transparent 50%,
      rgba(26, 15, 10, 0.4) 100%
    );
    pointer-events: none;
  }

  .module-header__container {
    max-width: 800px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .module-header__number {
    font-family: var(--font-headline);
    font-size: var(--text-lg);
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--color-gold);
    display: block;
    margin-bottom: var(--space-sm);
  }

  .module-header__title {
    font-family: var(--font-display);
    font-size: var(--text-4xl);
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: var(--space-md);
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }

  .module-header__subtitle {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-style: italic;
    opacity: 0.9;
    margin-bottom: var(--space-xl);
  }

  .module-header__drugs {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .module-header__drug-tag {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    background: rgba(201, 162, 39, 0.2);
    border: 1px solid var(--color-gold);
    color: var(--color-gold-light);
    padding: var(--space-xs) var(--space-md);
    border-radius: 2px;
  }

  .module-header__slides-btn {
    display: inline-block;
    margin-top: var(--space-lg);
    padding: var(--space-md) var(--space-2xl);
    background: transparent;
    color: var(--color-gold);
    text-decoration: none;
    border-radius: 0;
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 600;
    letter-spacing: 0.04em;
    transition: all var(--transition-base);
    border: 2px solid var(--color-gold);
    position: relative;
    overflow: hidden;
  }

  .module-header__slides-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--color-gold);
    transition: left var(--transition-base);
    z-index: -1;
  }

  .module-header__slides-btn:hover {
    color: var(--color-burgundy);
  }

  .module-header__slides-btn:hover::before {
    left: 0;
  }

  .module-header__bacteria {
    position: absolute;
    right: var(--space-xl);
    bottom: var(--space-xl);
    opacity: 0.3;
  }

  .module-header__bacteria-icon {
    width: 120px;
    height: 120px;
    background: rgba(245, 230, 211, 0.1);
    border: 2px dashed rgba(245, 230, 211, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    color: var(--color-cream);
    text-align: center;
    padding: var(--space-sm);
    overflow: hidden;
  }

  .module-header__bacteria-icon--image {
    padding: 0;
  }

  .module-header__bacteria-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .module-header__bacteria-placeholder {
    padding: var(--space-sm);
  }

  /* Layout do conteúdo */
  .module-content {
    display: grid;
    grid-template-columns: 1fr 260px;
    gap: var(--space-xl);
    max-width: 1100px;
    margin: 0 auto;
    padding: var(--space-xl) var(--space-lg);
  }

  .module-content__body {
    min-width: 0;
    max-width: 100%;
  }

  /* Prevenir overflow em todos os elementos de texto */
  .module-content__body :global(*) {
    max-width: 100%;
    box-sizing: border-box;
  }

  /* Estilos do conteúdo Markdown */
  .module-content__body :global(h2) {
    font-family: var(--font-display);
    font-size: var(--text-2xl);
    font-weight: 700;
    color: var(--color-blood-red);
    margin: var(--space-xl) 0 var(--space-md);
    padding-bottom: var(--space-xs);
    border-bottom: 2px solid var(--color-gold);
  }

  .module-content__body :global(h2:first-child) {
    margin-top: 0;
  }

  .module-content__body :global(h3) {
    font-family: var(--font-headline);
    font-size: var(--text-xl);
    letter-spacing: 0.03em;
    color: var(--text-primary);
    margin: var(--space-lg) 0 var(--space-sm);
  }

  .module-content__body :global(h4) {
    font-family: var(--font-body);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text-primary);
    margin: var(--space-md) 0 var(--space-xs);
  }

  .module-content__body :global(p) {
    margin-bottom: var(--space-sm);
    line-height: 1.7;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .module-content__body :global(ul),
  .module-content__body :global(ol) {
    margin-bottom: var(--space-sm);
    padding-left: var(--space-lg);
  }

  .module-content__body :global(li) {
    margin-bottom: var(--space-xs);
    line-height: 1.6;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  /* Wrapper para tabelas com scroll horizontal */
  .module-content__body :global(table) {
    border-collapse: collapse;
    margin: var(--space-md) 0;
    font-size: var(--text-sm);
    background: var(--color-cream);
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    max-width: 100%;
  }

  .module-content__body :global(thead) {
    background: linear-gradient(
      180deg,
      var(--color-sepia-dark) 0%,
      var(--color-sepia-medium) 100%
    );
    color: var(--text-light);
  }

  .module-content__body :global(th) {
    font-family: var(--font-headline);
    font-weight: 400;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    padding: var(--space-md);
    text-align: left;
  }

  .module-content__body :global(td) {
    padding: var(--space-md);
    border-bottom: 1px solid var(--color-parchment);
    word-wrap: break-word;
    overflow-wrap: break-word;
  }

  .module-content__body :global(tbody tr:hover) {
    background: var(--color-cream-dark);
  }

  .module-content__body :global(blockquote) {
    font-family: var(--font-display);
    font-style: italic;
    font-size: var(--text-base);
    color: var(--text-secondary);
    border-left: 4px solid var(--color-blood-red);
    padding: var(--space-sm) var(--space-md);
    margin: var(--space-md) 0;
    background: rgba(139, 21, 56, 0.05);
  }

  .module-content__body :global(strong) {
    color: var(--color-blood-red);
    font-weight: 700;
  }

  .module-content__body :global(code) {
    font-family: 'Courier New', monospace;
    background: var(--color-cream-dark);
    padding: 0.1em 0.3em;
    border-radius: 2px;
    font-size: 0.85em;
    word-break: break-word;
  }

  .module-content__body :global(hr) {
    border: none;
    border-top: 1px solid var(--color-parchment);
    margin: var(--space-lg) 0;
  }

  /* Sidebar */
  .module-sidebar {
    font-size: var(--text-sm);
  }

  .module-sidebar__sticky {
    position: sticky;
    top: calc(60px + var(--space-lg));
    max-height: calc(100vh - 60px - var(--space-xl));
    display: flex;
    flex-direction: column;
  }

  .module-sidebar__toc-wrapper {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    /* Scrollbar sutil */
    scrollbar-width: thin;
    scrollbar-color: var(--color-sepia-light) transparent;
  }

  .module-sidebar__toc-wrapper::-webkit-scrollbar {
    width: 6px;
  }

  .module-sidebar__toc-wrapper::-webkit-scrollbar-track {
    background: transparent;
  }

  .module-sidebar__toc-wrapper::-webkit-scrollbar-thumb {
    background-color: var(--color-sepia-light);
    border-radius: 3px;
  }

  .module-sidebar__toc-wrapper::-webkit-scrollbar-thumb:hover {
    background-color: var(--color-sepia-medium);
  }

  .module-sidebar__nav-section {
    margin-bottom: var(--space-xs);
  }

  .module-sidebar__title {
    font-family: var(--font-headline);
    font-size: var(--text-xs);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--color-sepia-medium);
    margin-bottom: var(--space-xs);
  }

  .module-sidebar__nav {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .module-sidebar__link {
    color: var(--color-blood-red);
    text-decoration: none;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-cream-dark);
    border-radius: var(--border-radius);
    transition: background var(--transition-fast);
    font-size: var(--text-xs);
  }

  .module-sidebar__link:hover {
    background: var(--color-parchment);
  }

  .module-sidebar__pagination {
    padding-bottom: var(--space-sm);
    margin-bottom: var(--space-sm);
    border-bottom: 1px solid var(--color-parchment);
  }

  .module-sidebar__pagination h4 {
    font-family: var(--font-headline);
    font-size: var(--text-xs);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--color-sepia-medium);
    margin-bottom: var(--space-xs);
  }

  .module-sidebar__prev,
  .module-sidebar__next {
    display: block;
    text-decoration: none;
    padding: var(--space-xs) var(--space-sm);
    margin-bottom: var(--space-xs);
    border: 1px solid var(--color-parchment);
    border-radius: var(--border-radius);
    transition: border-color var(--transition-fast);
    font-size: var(--text-xs);
  }

  .module-sidebar__prev:hover,
  .module-sidebar__next:hover {
    border-color: var(--color-blood-red);
  }

  .module-sidebar__pagination-label {
    font-size: 0.65rem;
    color: var(--text-secondary);
    display: block;
    line-height: 1.2;
  }

  .module-sidebar__pagination-title {
    color: var(--color-blood-red);
    font-weight: 600;
    font-size: var(--text-xs);
    line-height: 1.3;
  }

  /* Navegação inferior */
  .module-pagination {
    display: flex;
    justify-content: space-between;
    padding: var(--space-xl) var(--space-lg);
    background: var(--color-cream-dark);
    border-top: 1px solid var(--color-parchment);
    max-width: 1100px;
    margin: 0 auto;
  }

  .module-pagination__link {
    text-decoration: none;
    padding: var(--space-lg);
    background: var(--color-cream);
    border: 2px solid var(--color-sepia-light);
    border-radius: var(--border-radius);
    transition: all var(--transition-base);
    max-width: 45%;
  }

  .module-pagination__link:hover {
    border-color: var(--color-blood-red);
    box-shadow: var(--shadow-medium);
  }

  .module-pagination__link--next {
    text-align: right;
  }

  .module-pagination__label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    display: block;
    margin-bottom: var(--space-xs);
  }

  .module-pagination__title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-blood-red);
    font-weight: 600;
  }

  /* Responsividade */
  @media (max-width: 968px) {
    .module-content {
      grid-template-columns: 1fr;
      padding: var(--space-lg) var(--space-md);
    }

    .module-sidebar {
      order: -1;
    }

    .module-sidebar__sticky {
      position: static;
      max-height: none;
      display: block;
    }

    .module-sidebar__toc-wrapper {
      display: none;
    }

    .module-sidebar__pagination {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .module-header__bacteria {
      display: none;
    }

    .module-header__title {
      font-size: var(--text-3xl);
    }

    .module-header {
      padding: var(--space-xl) var(--space-md);
    }

    .module-pagination {
      padding: var(--space-xl) var(--space-md);
    }
  }

  @media (max-width: 600px) {
    .module-header {
      padding: var(--space-lg) var(--space-sm);
    }

    .module-header__title {
      font-size: var(--text-2xl);
    }

    .module-header__subtitle {
      font-size: var(--text-base);
    }

    .module-content {
      padding: var(--space-md) var(--space-sm);
    }

    .module-content__body :global(h2) {
      font-size: var(--text-xl);
      margin: var(--space-lg) 0 var(--space-sm);
    }

    .module-content__body :global(h3) {
      font-size: var(--text-lg);
    }

    .module-content__body :global(table) {
      font-size: var(--text-xs);
    }

    .module-content__body :global(th),
    .module-content__body :global(td) {
      padding: var(--space-sm);
    }

    .module-pagination {
      flex-direction: column;
      gap: var(--space-md);
      padding: var(--space-lg) var(--space-sm);
    }

    .module-pagination__link {
      max-width: 100%;
    }

    .module-pagination__link--next {
      text-align: left;
    }
  }
</style>
